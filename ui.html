<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css)">
    <link href="[https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Ma+Shan+Zheng&family=Long+Cang&display=swap](https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Ma+Shan+Zheng&family=Long+Cang&display=swap)" rel="stylesheet">
<style>
    :root {
        --c-bg: #f7f4ef;
        --c-ink: #2b2220;
        --c-red: #8a2e2e;    /* 宫墙红 */
        --c-pink: #d48888;   /* 暧昧粉 */
        --c-gold: #bfa46f;   /* 沉金 */
        --c-wood: #4a362f;   /* 檀木 */
        --c-jade: #6c8c8a;   /* 青玉 */
        --c-purple: #8e44ad; /* 紫气 */
        --c-gray: #7f8c8d;   /* 凡尘 */
        --f-title: 'Ma Shan Zheng', cursive; 
        --f-body: 'Noto Serif SC', serif;
        --shadow: 0 4px 12px rgba(43, 34, 32, 0.15);
        --tex-grain: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='[http://www.w3.org/2000/svg'%3E%3Cfilter](http://www.w3.org/2000/svg'%3E%3Cfilter) id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--f-body); color: var(--c-ink); background: transparent; }

    /* --- [ 1. 容器：紫檀宝匣 ] --- */
    .wrapper {
        position: relative; max-width: 600px; margin: 0 auto; height: 650px;
        background-color: var(--c-bg);
        background-image: var(--tex-grain);
        border: 6px solid var(--c-wood);
        border-radius: 8px;
        box-shadow: inset 0 0 0 2px var(--c-gold), 0 20px 60px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; overflow: hidden;
    }
    .corner {
        position: absolute; width: 40px; height: 40px; z-index: 90; pointer-events: none;
        border: 2px solid var(--c-gold); background: radial-gradient(circle at center, transparent, rgba(191, 164, 111, 0.1));
    }
    .ctl { top: 0; left: 0; border-right: 0; border-bottom: 0; border-radius: 2px 0 0 0; }
    .ctr { top: 0; right: 0; border-left: 0; border-bottom: 0; border-radius: 0 2px 0 0; }
    .cbl { bottom: 0; left: 0; border-right: 0; border-top: 0; border-radius: 0 0 0 2px; }
    .cbr { bottom: 0; right: 0; border-left: 0; border-top: 0; border-radius: 0 0 2px 0; }

    /* --- [ 2. 头部：圣旨卷轴 ] --- */
    .header {
        position: relative; padding: 20px 0 10px; text-align: center;
        background: linear-gradient(to bottom, #fffcf5, #f2efe6);
        border-bottom: 1px solid var(--c-gold);
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); z-index: 10;
    }
    .seal-box {
        position: absolute; top: 10px; right: 20px;
        width: 38px; height: 38px; border: 3px solid var(--c-red);
        color: var(--c-red); font-family: var(--f-title); font-size: 20px;
        display: grid; place-items: center; opacity: 0.85; transform: rotate(15deg);
        background: rgba(255,255,255,0.8); mask-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IndoaXRlIi8+PGNpcmNsZSBjeD0iNTAlIiBjeT0iNTAlIiByPSI0MCUiIGZpbGw9ImJsYWNrIiBmaWx0ZXI9InVybCgjbikiLz48L3N2Zz4=");
    }
    .title { 
        font-family: var(--f-title); font-size: 2.6em; color: var(--c-ink); margin: 0; 
        text-shadow: 2px 2px 0 rgba(191, 164, 111, 0.3); letter-spacing: 5px;
    }
    .sub-title { 
        font-family: 'Long Cang', cursive; font-size: 1.1em; color: var(--c-red); 
        margin-top: 5px; letter-spacing: 3px; font-weight: bold;
    }
    /* 跑马灯 */
    .ticker-box {
        background: rgba(191, 164, 111, 0.1); border-top: 1px dashed rgba(191, 164, 111, 0.3);
        padding: 6px 15px; font-size: 0.8em; color: #5d4e46; display: flex; justify-content: space-between;
        align-items: center;
    }
    .world-event { color: var(--c-red); font-weight: bold; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

    /* --- [ 3. 视口 ] --- */
    .viewport { 
        flex: 1; overflow-y: auto; padding: 15px 20px; padding-bottom: 100px;
        scrollbar-width: none;
    }
    .viewport::-webkit-scrollbar { display: none; }
    .tab { display: none; animation: fadeUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .tab.active { display: block; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* --- [ 4. 状态与通用卡片 ] --- */
    .card {
        background: #fff; border-radius: 6px; padding: 15px; margin-bottom: 15px;
        box-shadow: var(--shadow); position: relative; overflow: hidden;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .card::before { content:''; position: absolute; top:0; left:0; width:100%; height:3px; background:var(--c-gold); }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }

    .stat-item { display: flex; align-items: center; background: rgba(247, 244, 239, 0.8); padding: 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.03); }
    .s-icon {
        width: 28px; height: 28px; border-radius: 4px; 
        background: var(--c-ink); color: var(--c-gold);
        display: grid; place-items: center; margin-right: 8px;
        font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .s-data { display: flex; flex-direction: column; min-width: 0; flex: 1; }
    .s-lbl { font-size: 0.65em; color: #888; letter-spacing: 1px; margin-bottom: 2px; }
    .s-val { font-size: 0.95em; font-weight: 700; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* 命格配色 */
    .fate-gold { color: #f39c12; text-shadow: 0 0 2px rgba(243, 156, 18, 0.3); }
    .fate-purple { color: #9b59b6; }
    .fate-white { color: #2c3e50; }
    .fate-gray { color: #95a5a6; }

    /* 进度条 */
    .bar-box { margin-bottom: 8px; }
    .bar-head { display: flex; justify-content: space-between; font-size: 0.75em; color: #555; margin-bottom: 3px; font-weight: bold; }
    .bar-track { height: 8px; background: #e0dcd0; border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .bar-fill { height: 100%; width: 0; transition: width 0.8s ease; position: relative; border-radius: 4px; }
    .c-xp { background: #d4af37; } .c-hp { background: #a63737; } .c-mp { background: #3f5c7a; } .c-san { background: #27ae60; }
    .c-san.low { background: #c0392b; animation: pulse 1s infinite; }

    /* --- [ 5. 财富系统 ] --- */
    .wealth-panel {
        background: linear-gradient(to bottom, #fffcf5, #fff); 
        border: 1px solid var(--c-gold); border-radius: 6px;
        padding: 12px; margin-bottom: 15px; box-shadow: var(--shadow);
    }
    .w-row { display: flex; gap: 10px; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
    .w-row:last-child { margin: 0; border: 0; padding: 0; }
    .w-item {
        flex: 1; display: flex; flex-direction: column; align-items: center;
        background: rgba(191, 164, 111, 0.05); padding: 6px; border-radius: 4px;
    }
    .w-icon { font-size: 1.2em; margin-bottom: 4px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
    .w-val { font-family: monospace; font-weight: bold; color: var(--c-ink); font-size: 1.1em; }
    .w-lbl { font-size: 0.6em; color: #999; transform: scale(0.9); }
    
    .i-top { color: #9b59b6; } .i-high { color: #3498db; } .i-mid { color: #2ecc71; } .i-low { color: #95a5a6; }
    .i-gold { color: #f1c40f; } .i-silver { color: #bdc3c7; } .i-copper { color: #d35400; }

    /* --- [ 6. 社交：极乐宝鉴 (增强版) ] --- */
    details.npc {
        background: #fff; border-radius: 4px; margin-bottom: 12px;
        border: 1px solid #e6e2d8; transition: 0.3s;
    }
    details.npc[open] { border-color: var(--c-red); box-shadow: 0 8px 20px rgba(138, 46, 46, 0.15); }
    
    details.npc > summary {
        list-style: none; padding: 12px; cursor: pointer;
        display: grid; grid-template-columns: 50px 1fr 30px; gap: 12px; align-items: start;
    }
    details.npc > summary::-webkit-details-marker { display: none; }

    .ava { 
        width: 50px; height: 50px; border-radius: 8px; 
        background: var(--c-ink); color: #f4f0e6; border: 2px solid var(--c-gold);
        display: grid; place-items: center; font-family: var(--f-title); font-size: 1.8em;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .n-info { display: flex; flex-direction: column; width: 100%; }
    .n-top { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; flex-wrap: wrap; }
    .n-name { font-size: 1.1em; font-weight: 700; color: #222; }
    .n-tier { font-size: 0.7em; color: var(--c-red); border: 1px solid var(--c-red); padding: 0 4px; border-radius: 2px; background: #fff; }
    .n-fac { font-size: 0.7em; background: #eee; padding: 1px 4px; border-radius: 2px; color: #666; }
    .n-bars { width: 100%; margin-top: 5px; display: flex; gap: 4px; }
    .mini-bar { height: 4px; border-radius: 2px; background: #eee; flex: 1; overflow: hidden; }
    .mini-fill { height: 100%; }

    .stamp { 
        width: 32px; height: 32px; display: grid; place-items: center;
        border: 2px solid #e0e0e0; border-radius: 4px; color: #ccc;
        font-family: var(--f-title); font-size: 1em; transform: rotate(-5deg);
        margin-top: 5px;
    }
    .stamp.active { border-color: var(--c-red); color: var(--c-red); background: rgba(158, 42, 43, 0.05); }

    /* 极乐详情 */
    .detail { padding: 15px; background: #fbfaf8; border-top: 1px dashed #ddd; font-size: 0.95em; color: #444; }
    
    .status-bubble {
        background: linear-gradient(to right, #fff5f5, #fff); 
        border-left: 3px solid var(--c-pink); padding: 10px; border-radius: 0 4px 4px 0;
        margin-bottom: 12px; font-size: 0.9em; color: #555;
    }
    .sb-h { color: var(--c-red); font-weight: bold; font-size: 0.8em; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
    .sb-txt { font-style: italic; line-height: 1.5; }
    .thought { margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(212, 136, 136, 0.3); color: #888; font-size: 0.85em; }

    .bond-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .bond-item { 
        background: #fff; border: 1px solid #eee; padding: 6px; 
        border-radius: 4px; text-align: center; 
    }
    .bi-lbl { font-size: 0.7em; color: #aaa; margin-bottom: 2px; }
    .bi-val { font-weight: bold; color: var(--c-ink); }
    .bi-val.virgin { color: var(--c-red); text-shadow: 0 0 5px rgba(138, 46, 46, 0.2); }

    .d-section { margin-bottom: 10px; }
    .d-lbl { color: var(--c-gold); font-weight: bold; font-size: 0.85em; margin-bottom: 4px; display: block; }
    .d-val { line-height: 1.6; text-align: justify; white-space: pre-wrap; font-size: 0.9em; }
    
    .tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; }
    .skill-tag { 
        font-size: 0.8em; padding: 2px 8px; border-radius: 4px;
        background: rgba(108, 140, 138, 0.1); color: var(--c-jade); border: 1px solid rgba(108, 140, 138, 0.3);
    }

    /* --- [ 7. 底部导航 ] --- */
    .nav {
        position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px; height: 60px;
        background: linear-gradient(to bottom, #fff, #f0f0f0);
        border: 1px solid #ccc; border-radius: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex; justify-content: space-evenly; align-items: center; z-index: 100;
    }
    .nav-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 50px; height: 100%; color: #998a7b; transition: 0.3s;
    }
    .nav-btn i { font-size: 1.3em; margin-bottom: 2px; filter: drop-shadow(0 1px 0 #fff); }
    .nav-btn span { font-size: 0.7em; font-family: var(--f-title); opacity: 0.8; transform: scale(0.9); }
    .nav-btn.active { color: var(--c-red); transform: translateY(-3px); }
    .nav-btn.active span { opacity: 1; transform: scale(1); font-weight: bold; }

    /* --- [ 8. 其他 ] --- */
    .news-card { background: #fff; padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--c-red); box-shadow: var(--shadow); }
    .news-h { color: var(--c-red); font-weight: bold; margin-bottom: 5px; font-family: var(--f-title); font-size: 1.1em; }
    .bag-item { display: flex; justify-content: space-between; padding: 12px; background: #fff; border: 1px solid #eee; margin-bottom: 8px; border-radius: 4px; }
    .empty { padding: 50px; text-align: center; color: #ccc; font-family: var(--f-title); font-size: 1.4em; opacity: 0.6; }

</style>
</head>
<body>
    
    <div class="wrapper">
        <div class="corner ctl"></div><div class="corner ctr"></div>
        <div class="corner cbl"></div><div class="corner cbr"></div>
        <div id="loading" style="flex:1; display:grid; place-items:center; color:#998;">
            <div style="text-align:center">
                <i class="fa-solid fa-yin-yang fa-spin" style="font-size:2.5em; color:var(--c-gold); margin-bottom:15px; opacity:0.8; filter:drop-shadow(0 2px 5px rgba(0,0,0,0.2))"></i>
                <div style="font-family:var(--f-title); font-size:1.6em; color:var(--c-ink); letter-spacing:2px">天道推演中</div>
            </div>
        </div>
    </div>

<script>
(function() {
    const scripts = document.getElementsByTagName('script');
    const el = scripts[scripts.length - 1].previousElementSibling;
    if (!el || !el.classList.contains('wrapper')) return;
    if (el.getAttribute('data-init') === 'true') return;
    el.setAttribute('data-init', 'true');

    const get = (o, p, d) => {
        try {
            return p.split('.').reduce((obj, k) => {
                const m = k.match(/^(.+?)\[(\d+)\]$/);
                return m ? obj[m[1]][parseInt(m[2])] : obj[k];
            }, o) ?? d;
        } catch { return d; }
    };
    
    const getList = (root, path) => {
        let v = get(root, path);
        while (Array.isArray(v) && v.length > 0) v = v[0];
        if (typeof v === 'object' && v !== null) return v;
        return {};
    };

    const safeStr = (val) => {
        if (Array.isArray(val)) return val[0] || '无';
        if (typeof val === 'object') return '未知';
        return val || '无';
    };

    // 提取数字，用于进度条
    const safeNum = (val) => parseFloat(val) || 0;

    const parseSkills = (obj) => {
        if (!obj || typeof obj !== 'object') return '无';
        const keys = Object.keys(obj).filter(k => k !== '$meta');
        if (keys.length > 0) {
            if (obj['名称']) return safeStr(obj['名称']); 
            return keys.map(k => {
                const item = obj[k];
                return safeStr(get(item, '名称', k));
            }).join('、');
        }
        if (obj['名称']) return safeStr(obj['名称']);
        return '无';
    };
    
    // 气运颜色解析
    const fateClass = (txt) => {
        if(!txt) return '';
        if(txt.includes('金')) return 'fate-gold';
        if(txt.includes('紫')) return 'fate-purple';
        if(txt.includes('白')) return 'fate-white';
        return 'fate-gray';
    };

    const fmt = s => (s||'').toString().replace(/\\\\n/g, '\n').replace(/\\n/g, '\n');

    const App = {
        Header: (d) => `
            <div class="header">
                <div class="seal-box">道</div>
                <h1 class="title">九宸玄陆</h1>
                <div class="sub-title">· 极乐宝鉴 ·</div>
            </div>
            <div class="ticker-box">
                <div>
                    <span style="margin-right:10px"><i class="fa-regular fa-clock"></i> ${get(d,'世界.时间[0]','太古历')}</span>
                    <span><i class="fa-solid fa-location-dot"></i> ${get(d,'世界.地点[0]','未知之地')}</span>
                </div>
                <div class="world-event">${get(d, '世界.世界动态[0]', '天地不仁')}</div>
            </div>`,

        Status: (d) => {
            const p = get(d, '主角', {});
            const n = k => safeNum(get(p, k, 0));
            const m = k => safeNum(get(p, k, 1));
            const Card = (icon, l, v, c='') => `<div class="stat-item"><div class="s-icon"><i class="${icon}"></i></div><div class="s-data"><div class="s-lbl">${l}</div><div class="s-val ${c}">${v}</div></div></div>`;
            const Bar = (l, c, mx, cls) => `<div class="bar-box"><div class="bar-head"><span>${l}</span><span>${c} / ${mx}</span></div><div class="bar-track"><div class="bar-fill ${cls}" style="width:${Math.min(100, mx>0?(c/mx)*100:0)}%"></div></div></div>`;
            const st = parseSkills(getList(d, '主角.功法'));
            const sp = parseSkills(getList(d, '主角.神通'));
            const san = n('道心[0]');

            return `
            <div class="grid-2">
                ${Card('fa-solid fa-crown', '境界', get(p,'境界[0]','凡人'))}
                ${Card('fa-solid fa-dna', '灵根', get(p,'灵根[0]','未知'))}
                ${Card('fa-solid fa-dragon', '种族', get(p,'种族[0]','未知'))}
                ${Card('fa-solid fa-child-reaching', '体质', get(p,'体质[0]','凡体'))}
            </div>
            <div class="grid-3">
                ${Card('fa-solid fa-hourglass', '骨龄', get(p,'年龄[0]','18'))}
                ${Card('fa-solid fa-yin-yang', '气运', get(p,'气运[0]','凡'), fateClass(get(p,'气运[0]')))}
                ${Card('fa-solid fa-brain', '道心', san, san<30?'i-copper':'')}
            </div>
            <div class="card">
                ${Bar('悟道', n('悟[0]'), 100, 'c-xp')}
                ${Bar('生命', n('当前命[0]'), m('命[0]'), 'c-hp')}
                ${Bar('灵力', n('当前灵[0]'), m('灵[0]'), 'c-mp')}
                ${Bar('道心稳固', san, 100, 'c-san ' + (san<30?'low':''))}
            </div>
            <div class="card" style="border-left:4px solid var(--c-jade)">
                <div class="d-lbl" style="color:var(--c-jade)">功法神通</div>
                <div style="font-size:0.95em;line-height:1.6">${st} | ${sp}</div>
            </div>`;
        },

        Social: (d) => {
            const list = getList(d, '寻缘蝶');
            const keys = Object.keys(list).filter(k=>k!=='$meta');
            if(!keys.length) return `<div class="empty">云深不知处<br>故人何处寻</div>`;

            return keys.map(k => {
                const n = list[k];
                const fav = safeNum(get(n, '好感度[0]', 0));
                const gf = parseSkills(getList(n, '功法'));
                const st = parseSkills(getList(n, '神通'));
                const virgin = get(n, '元阴[0]', '未知');
                const count = get(n, '合欢数[0]', '0');
                const hp = safeNum(get(n, '当前命[0]', 100));
                const hpM = safeNum(get(n, '命[0]', 100));
                const mp = safeNum(get(n, '当前灵[0]', 100));
                const mpM = safeNum(get(n, '灵[0]', 100));
                const luck = get(n, '气运[0]', '未知');
                const san = safeNum(get(n, '道心[0]', 100));

                return `
                <details class="npc">
                    <summary>
                        <div class="ava-w"><div class="ava">${get(n,'姓名[0]',k)[0]}</div></div>
                        <div class="n-info">
                            <div class="n-top">
                                <div class="n-name">${get(n,'姓名[0]',k)}</div>
                                <div class="n-tier">${get(n,'境界[0]','?')}</div>
                                <div class="n-fac">${get(n,'势力[0]','散修')}</div>
                            </div>
                            <div class="n-sub" style="font-size:0.75em;color:#888">${get(n,'种族[0]','')} · ${get(n,'性格[0]','')}</div>
                            <div class="n-bars">
                                <div class="mini-bar"><div class="mini-fill c-hp" style="width:${(hp/hpM)*100}%"></div></div>
                                <div class="mini-bar"><div class="mini-fill c-mp" style="width:${(mp/mpM)*100}%"></div></div>
                            </div>
                        </div>
                        <div class="stamp ${fav>=0?'active':''}">${fav}</div>
                    </summary>
                    <div class="detail">
                        <div class="status-bubble">
                            <div class="sb-h"><i class="fa-solid fa-heart-pulse"></i> 身心状态</div>
                            <div class="sb-txt">${get(n,'当前状态[0]','平静')}</div>
                            <div class="thought"><i class="fa-regular fa-comment-dots"></i> ${get(n,'心理活动[0]','无')}</div>
                        </div>
                        
                        <div class="grid-3" style="margin-bottom:10px; text-align:center;">
                             <div class="w-item"><span class="bi-lbl">骨龄</span><span class="bi-val">${get(n,'年龄[0]','?')}</span></div>
                             <div class="w-item"><span class="bi-lbl">气运</span><span class="bi-val ${fateClass(luck)}">${luck}</span></div>
                             <div class="w-item"><span class="bi-lbl">道心</span><span class="bi-val ${san<30?'i-copper':''}">${san}</span></div>
                        </div>

                        <div class="bond-grid">
                            <div class="bond-item"><div class="bi-lbl">元阴(贞洁)</div><div class="bi-val ${virgin.includes('锁')?'virgin':''}">${virgin}</div></div>
                            <div class="bond-item"><div class="bi-lbl">合欢次数</div><div class="bi-val">${count}</div></div>
                        </div>
                        <div class="grid-2" style="margin-bottom:10px">
                            <div class="d-row"><span class="d-lbl">灵根</span><span class="d-val">${get(n,'灵根[0]','?')}</span></div>
                            <div class="d-row"><span class="d-lbl">体质</span><span class="d-val">${get(n,'体质[0]','?')}</span></div>
                        </div>
                        <div class="d-section"><div class="d-lbl">灵器法宝</div><div class="d-val">${get(n,'灵器[0]','暂无本命物')}</div></div>
                        <div class="d-section"><div class="d-lbl">姿容衣着</div><div class="d-val">${get(n,'外貌[0]','暂无')}<br>${get(n,'衣着[0]','暂无')}</div></div>
                        <div class="skill-box">
                            <div class="d-lbl">功法神通</div>
                            <div class="tag-cloud">
                                <span class="skill-tag">${gf}</span><span class="skill-tag">${st}</span>
                            </div>
                        </div>
                    </div>
                </details>`;
            }).join('');
        },

        Bag: (d) => {
            const w = get(d, '资产', {});
            const l = getList(d, '行囊.背包');
            const keys = Object.keys(l).filter(k=>k!=='$meta');
            
            const Wealth = `
            <div class="wealth-panel">
                <div class="w-row">
                    <div class="w-item"><div class="w-icon i-top"><i class="fa-regular fa-gem"></i></div><div class="w-val">${get(w,'极品灵石[0]',0)}</div><div class="w-lbl">极品</div></div>
                    <div class="w-item"><div class="w-icon i-high"><i class="fa-solid fa-gem"></i></div><div class="w-val">${get(w,'上品灵石[0]',0)}</div><div class="w-lbl">上品</div></div>
                    <div class="w-item"><div class="w-icon i-mid"><i class="fa-solid fa-gem"></i></div><div class="w-val">${get(w,'中品灵石[0]',0)}</div><div class="w-lbl">中品</div></div>
                    <div class="w-item"><div class="w-icon i-low"><i class="fa-solid fa-gem"></i></div><div class="w-val">${get(w,'下品灵石[0]',0)}</div><div class="w-lbl">下品</div></div>
                </div>
                <div class="w-row">
                    <div class="w-item"><div class="w-icon i-gold"><i class="fa-solid fa-coins"></i></div><div class="w-val">${get(w,'黄金[0]',0)}</div><div class="w-lbl">黄金</div></div>
                    <div class="w-item"><div class="w-icon i-silver"><i class="fa-solid fa-coins"></i></div><div class="w-val">${get(w,'白银[0]',0)}</div><div class="w-lbl">白银</div></div>
                    <div class="w-item"><div class="w-icon i-copper"><i class="fa-solid fa-coins"></i></div><div class="w-val">${get(w,'铜钱[0]',0)}</div><div class="w-lbl">铜钱</div></div>
                </div>
            </div>`;

            const Items = keys.length ? keys.map(k => `
                <div class="bag-item">
                    <div>
                        <div style="font-weight:bold;color:var(--c-ink)">${get(l[k],'名称[0]',k)}</div>
                        <div style="font-size:0.85em;color:#999;margin-top:4px">${get(l[k],'描述[0]','')}</div>
                    </div>
                    <div style="color:var(--c-gold);font-weight:bold">x${get(l[k],'数量[0]',1)}</div>
                </div>`).join('') : `<div class="empty">袖里乾坤<br>空空如也</div>`;
            
            return Wealth + Items;
        },

        News: (d) => {
            const n = get(d, '宅仙报', {});
            const Box = (t, c) => `<div class="news-card"><div class="news-h">${t}</div><div style="font-size:0.95em;line-height:1.7;color:#555;white-space:pre-wrap">${fmt(c)}</div></div>`;
            return Box('散仙小道', get(n,'散仙小道[0]')) + Box('天机阁', get(n,'天机阁[0]')) + Box('宅仙有话说', get(n,'宅仙有话说[0]'));
        }
    };

    const render = (data) => {
        if (!el.querySelector('.nav')) {
            el.innerHTML = `
                ${App.Header(data)}
                <div class="viewport">
                    <div id="p-status" class="tab active"></div>
                    <div id="p-bag" class="tab"></div>
                    <div id="p-social" class="tab"></div>
                    <div id="p-news" class="tab"></div>
                </div>
                <div class="nav">
                    <div class="nav-btn active" onclick="sw('status',this)"><i class="fa-solid fa-user-astronaut"></i><span>道体</span></div>
                    <div class="nav-btn" onclick="sw('bag',this)"><i class="fa-solid fa-box-open"></i><span>行囊</span></div>
                    <div class="nav-btn" onclick="sw('social',this)"><i class="fa-solid fa-heart"></i><span>寻缘</span></div>
                    <div class="nav-btn" onclick="sw('news',this)"><i class="fa-solid fa-scroll"></i><span>天机</span></div>
                </div>`;
            
            window.sw = (id, btn) => {
                el.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
                el.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                el.querySelector(`#p-${id}`).classList.add('active');
                btn.classList.add('active');
                fill(id, window.lastData);
            };
        } else {
             // 仅更新头部 ticker
             const ev = get(data, '世界.世界动态[0]', '天地不仁');
             const tm = get(data, '世界.时间[0]');
             const lc = get(data, '世界.地点[0]');
             el.querySelector('.ticker-box').innerHTML = `<div><span style="margin-right:10px"><i class="fa-regular fa-clock"></i> ${tm}</span><span><i class="fa-solid fa-location-dot"></i> ${lc}</span></div><div class="world-event">${ev}</div>`;
        }
        
        window.lastData = data;
        const act = el.querySelector('.nav-btn.active').getAttribute('onclick').match(/'(.*?)'/)[1];
        fill(act, data);
        document.getElementById('loading')?.remove();
    };

    const fill = (id, d) => {
        const c = el.querySelector(`#p-${id}`);
        if(id === 'status') c.innerHTML = App.Status(d);
        if(id === 'social') c.innerHTML = App.Social(d);
        if(id === 'bag') c.innerHTML = App.Bag(d);
        if(id === 'news') c.innerHTML = App.News(d);
    };

    const init = async () => {
        try {
            const msgs = typeof getChatMessages === 'function' ? await getChatMessages(getCurrentMessageId()) : [];
            const data = msgs?.[0]?.data?.stat_data || {};
            render(data);
            if (typeof waitGlobalInitialized === 'function') {
                waitGlobalInitialized('Mvu').then(() => {
                    if (typeof Mvu !== 'undefined') eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => m?.stat_data && render(m.stat_data));
                });
            }
        } catch(e) { console.error(e); }
    };

    if (typeof waitGlobalInitialized === 'function') waitGlobalInitialized('Mvu').then(init);
    else setTimeout(init, 100);

})();
</script>
</body>
</html>
